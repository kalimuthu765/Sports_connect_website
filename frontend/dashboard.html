<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - SportsConnect</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root{
  --primary-blue:#00e0ff;
  --secondary-color:#5efc82;
  --text-light:#e8f7ff;
  --text-secondary:#a0c4ff;
  --bg-dark:#0f2027;
  --bg-mid:#203a43;
}

/* reset + base */
*{box-sizing:border-box}
body{
  font-family:'Poppins',sans-serif;
  margin:0;padding:0;
  color:var(--text-light);
  background:linear-gradient(135deg,var(--bg-dark),var(--bg-mid));
  background-size:200% 200%;
  min-height:100vh;
  padding-top:72px; /* allow navbar space */
}

/* NAVBAR */
.navbar{
  position:fixed;top:0;left:0;right:0;
  height:64px;display:flex;align-items:center;justify-content:space-between;
  padding:12px 36px;background:rgba(15,32,39,0.95);backdrop-filter:blur(8px);
  border-bottom:2px solid var(--primary-blue);z-index:140;
}
.navbar-brand{ color:var(--primary-blue); font-weight:700; font-size:22px; text-decoration:none; }
.navbar-links{ display:flex; gap:18px; align-items:center; white-space:nowrap; }
.navbar-links a, .navbar-links button { color:var(--text-light); text-decoration:none; background:none; border:none; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:500; }
.btn { padding:10px 18px; border-radius:8px; border:none; font-weight:700; cursor:pointer; background:linear-gradient(90deg,var(--primary-blue),var(--secondary-color)); color:#000; box-shadow:0 6px 18px rgba(0,224,255,0.12); transition:all .18s ease; }
.btn:hover { transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,224,255,0.20); }
.btn-sm{ padding:8px 14px; font-size:.95rem; }

/* main layout */
.container{ max-width:1400px; margin:28px auto; display:flex; gap:24px; padding:0 18px; align-items:flex-start; }
main{ flex:2 } aside{ flex:1; display:flex; flex-direction:column; gap:22px; }

/* card base - glass */
.card{
  background:linear-gradient(180deg, rgba(8,18,22,0.55), rgba(6,12,14,0.48));
  border:1px solid rgba(0,224,255,0.14);
  border-radius:16px;
  padding:20px;
  box-shadow:0 8px 30px rgba(0,0,0,0.55), 0 0 10px rgba(0,224,255,0.05);
  backdrop-filter: blur(10px) saturate(140%);
  transition:all .22s ease;
}
.card:hover{ box-shadow:0 16px 40px rgba(0,0,0,0.6), 0 0 18px rgba(94,252,130,0.16); border-color:rgba(94,252,130,0.25); transform:translateY(-4px); }
.card h2, .card h3{ margin:0 0 14px 0; color:var(--text-light); display:flex; align-items:center; gap:10px; }

/* PROFILE CARD - GLASS GRADIENT */
#dashboard-profile-header{
  padding:22px;
  border-radius:16px;
  background:linear-gradient(135deg, rgba(0,224,255,0.04), rgba(94,252,130,0.03));
  border:1px solid rgba(0,224,255,0.22);
  box-shadow:0 10px 30px rgba(0,0,0,0.55), 0 0 20px rgba(0,224,255,0.08);
}
.profile-main-area{ display:flex; gap:18px; align-items:center; }
.dash-avatar{ width:86px; height:86px; border-radius:50%; object-fit:cover; border:3px solid var(--primary-blue); box-shadow:0 0 18px rgba(0,224,255,0.55); }
.dash-info h3{ margin:0; font-size:1.4rem; color:var(--text-light); }
.dash-info p{ margin:0; color:var(--text-secondary); text-transform:lowercase; font-size:0.95rem; }
.dash-stats{ display:flex; gap:22px; margin-top:14px; border-top:1px solid rgba(255,255,255,0.04); padding-top:12px; align-items:center; }
.dash-stat-item{ cursor:pointer; text-align:left; }
.dash-stat-item strong{ display:block; color:var(--primary-blue); font-size:1.05rem; }
.dash-stat-item span{ color:var(--text-secondary); font-size:0.85rem; }

/* View followers & following buttons */
.dash-stat-actions{ display:flex; gap:10px; margin-top:12px; }
.link-small{ background:rgba(0,224,255,0.06); border:1px solid rgba(0,224,255,0.12); color:var(--text-light); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }

/* My Team card (kept simple) */
#team-info-card{ padding:18px; }

/* FEED with internal scroll */
.feed-card{ display:flex; flex-direction:column; gap:12px; }
#feed{ max-height:62vh; overflow-y:auto; padding-right:8px; }
#feed::-webkit-scrollbar{ width:9px; }
#feed::-webkit-scrollbar-thumb{ background:linear-gradient(180deg, rgba(0,224,255,0.12), rgba(94,252,130,0.12)); border-radius:8px; border:2px solid rgba(0,0,0,0.1); }
.post{ background:rgba(255,255,255,0.06); padding:14px; margin-bottom:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
.post-header{ color:var(--secondary-color); font-weight:800; margin-bottom:8px; }

/* RECOMMENDED (keeps glass look) */
#recommended-list{ display:flex; flex-direction:column; gap:10px; padding:6px 0; }
#recommended-list li{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:10px; background:linear-gradient(135deg, rgba(0,224,255,0.03), rgba(0,0,0,0.02)); border:1px solid rgba(0,224,255,0.08); }
.reco-left{ display:flex; align-items:center; gap:10px; }
.reco-left img{ width:36px; height:36px; border-radius:50%; border:2px solid var(--primary-blue); }
.reco-name{ color:var(--primary-blue); font-weight:700; text-decoration:none; }

/* LIVE TOURNAMENTS */
#tournaments-list{
  display:flex; flex-direction:column; gap:12px; padding:8px 0;
}
#tournaments-list li{
  padding:12px 16px;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(8,18,24,0.45), rgba(12,26,32,0.38));
  border:1px solid rgba(0,224,255,0.18);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 0 6px 18px rgba(0,0,0,0.45);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  transition: all .18s ease;
}
#tournaments-list li a{ color:var(--text-light); text-decoration:none; font-weight:600; }
#tournaments-list li:hover{
  transform:translateY(-4px);
  border-color:rgba(94,252,130,0.3);
  box-shadow: 0 12px 28px rgba(0,0,0,0.55), 0 0 18px rgba(0,224,255,0.08);
  background: linear-gradient(180deg, rgba(0,224,255,0.02), rgba(94,252,130,0.02));
}
.tourn-pill{ padding:6px 10px; border-radius:999px; font-weight:700; background:rgba(0,0,0,0.25); color:var(--text-secondary); border:1px solid rgba(255,255,255,0.03); }

/* MODALS: post & follow */
.modal-overlay{ display:none; position:fixed; inset:0; z-index:160; background:rgba(0,0,0,0.75); justify-content:center; align-items:center; }
.modal-box{
  width:92%; max-width:540px;
  background:linear-gradient(135deg, rgba(12,22,28,0.95), rgba(0,0,0,0.55));
  padding:22px; border-radius:14px; border:1px solid rgba(0,224,255,0.2); box-shadow:0 10px 30px rgba(0,0,0,0.6);
}
.modal-box h3{ color:var(--secondary-color); margin:0 0 12px 0; }
.modal-close{ float:right; cursor:pointer; color:var(--text-light); font-size:1.4rem; }
.modal-list{ max-height:56vh; overflow-y:auto; padding-right:6px; margin-top:8px; }

/* âœ… ENHANCED fuser STYLING */
.fuser{ 
    display:flex; 
    align-items:center; 
    justify-content: space-between; 
    padding:10px; /* Add padding inside the item */
    margin-bottom: 8px; /* Space between items */
    border-radius: 8px;
    background: rgba(255,255,255,0.03); /* Subtle background */
    border: 1px solid rgba(0,224,255,0.1);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
}
.fuser:hover {
    background: rgba(0,224,255,0.05); /* Highlight on hover */
    box-shadow: 0 6px 15px rgba(0,0,0,0.4), 0 0 5px var(--primary-blue);
    transform: translateY(-2px);
}

.fuser-info {
    display: flex;
    align-items: center;
    gap: 12px;
}
.fuser img{ 
    width:44px; 
    height:44px; 
    border-radius:50%; 
    border:2px solid var(--primary-blue); 
}
.fuser-name{
    color:var(--text-light); 
    text-decoration:none; 
    font-weight:700;
}
.fuser-name:hover {
    color: var(--secondary-color);
}


/* ====== CHATBOT LINK STYLING ====== */
#chatbot-link-card {
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all .22s ease;
    text-decoration: none; /* Make it look like a seamless card */
    display: block;
}
#chatbot-link-card:hover {
    transform: scale(1.02);
    border-color: var(--secondary-color);
}
.chatbot-icon {
    font-size: 2.5rem;
    color: var(--secondary-color);
    text-shadow: 0 0 10px rgba(94,252,130,0.5);
    margin-bottom: 8px;
}
.chatbot-text {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-light);
}


/* responsive */
@media (max-width: 992px){
  .container{ flex-direction:column; padding:0 12px; margin-top:18px; }
  .navbar{ padding:12px 18px; }
  #dashboard-profile-header{ padding:16px; }
}
</style>
</head>
<body>

<nav class="navbar">
  <a class="navbar-brand" href="dashboard.html">SportsConnect</a>
  <div class="navbar-links">
    <button class="btn btn-sm" onclick="openPostModal()"><i class="fas fa-edit"></i> Start a Post</button>
    <a href="profile.html"><i class="fas fa-user-circle"></i> Profile</a>
    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>
</nav>

<div id="postModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true">
    <span class="modal-close" onclick="closePostModal()">&times;</span>
    <h3>Create New Post</h3>
    <textarea id="modal-post-caption" placeholder="What's on your mind?" style="width:100%;min-height:110px;border-radius:8px;border:1px solid rgba(0,224,255,0.12);background:rgba(0,0,0,0.45);color:var(--text-light);padding:10px;"></textarea>
    <div style="margin-top:12px;"><button class="btn" onclick="createPostFromModal()">Post</button></div>
  </div>
</div>

<div id="followModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true">
    <span class="modal-close" onclick="closeFollowModal()">&times;</span>
    <h3 id="followModalTitle">Followers</h3>
    <div id="followList" class="modal-list"><p style="color:var(--text-secondary);">Loading...</p></div>
  </div>
</div>
<div class="container">
  <aside>
    <div id="dashboard-profile-header" class="card">
      <p style="color:var(--text-secondary);">Loading profile...</p>
    </div>

    <div id="team-info-card" class="card">
      <h3><i class="fas fa-shield-alt"></i> My Team</h3>
      <div id="player-team-status"><p style="color:var(--text-secondary);">Loading...</p></div>
    </div>
    
    <div id="join-requests-card" class="card" style="display: none;">
        <h3><i class="fas fa-envelope-open-text"></i> Join Requests</h3>
        <ul id="join-requests-list" class="item-list">
            <p style="color:var(--text-secondary); margin:0;">Loading requests...</p>
        </ul>
    </div>
    <a href="chatbot.html" id="chatbot-link-card" class="card">
        <div class="chatbot-icon"><i class="fas fa-robot"></i></div>
        <div class="chatbot-text">Ask the Sports AI</div>
    </a>
    </aside>

  <main>
    <div class="card feed-card">
      <h2><i class="fas fa-bullhorn"></i> Social Feed</h2>
      <button class="btn btn-sm" style="width:100%; margin-bottom:14px;" onclick="openPostModal()">Click here to share an update</button>
      <div id="feed"><p style="color:var(--text-secondary);">Loading feed...</p></div>
    </div>
  </main>

  <aside>
    <div class="card">
      <h3><i class="fas fa-medal"></i> Live Tournaments</h3>

      <div id="create-tournament-container" style="display: none;">
        <button id="create-tournament-btn" class="btn btn-sm" style="width:100%; margin-bottom:10px;"
                onclick="openCreateTournament()">
          <i class="fas fa-plus-circle"></i> Create Tournament
        </button>
      </div>
      <ul id="tournaments-list" class="item-list">
        <p style="color:var(--text-secondary); margin:0;">Loading tournaments...</p>
      </ul>
    </div>


    <div class="card">
      <h3><i class="fas fa-handshake"></i> Recommended</h3>
      <ul id="recommended-list" class="item-list">
        <p style="color:var(--text-secondary); margin:0;">No recommendations right now.</p>
      </ul>
    </div>
  </aside>
</div>

<script>
/* Auth + helper */
const token = localStorage.getItem("token");
const userId = localStorage.getItem("userId");
if (!token || !userId) {
  window.location.href = "index.html";
}
function logout(){
  localStorage.clear();
  window.location.href = "index.html";
}
// FINAL apiRequest function (ensure this is identical to your running version)
async function apiRequest(endpoint, method = 'GET', body = null){
  const opts = { method, headers: { 'Authorization': 'Bearer ' + token } };
  if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  const res = await fetch(`http://localhost:5000${endpoint}`, opts);
  if (!res.ok) {
    // This is the block that throws the error you see
    try { const j = await res.json(); throw new Error(j.message || 'API request failed'); } catch (e) { throw new Error('API request failed'); }
  }
  return res.status === 204 ? null : res.json();
}

/* Profile + My Team */
let currentFollowingIds = [];

async function loadProfile(){
  try{
    // The /api/users/me endpoint populates 'joinRequests.player' and 'team'
    const user = await apiRequest('/api/users/me'); 
    
    // Store IDs of users the current user is following for the modal logic
    currentFollowingIds = user.following.map(f => f._id);
    
    // 1. Tournament Creation Visibility Check (Teams/Organizers only)
    const createBtnContainer = document.getElementById('create-tournament-container');
    if (createBtnContainer) {
        // Only visible for roles 'team' or 'organizer'
        if (user.role === 'team' || user.role === 'organizer') {
            createBtnContainer.style.display = 'block';
        } else {
            createBtnContainer.style.display = 'none';
        }
    }
    
    // Existing profile header rendering
    const avatarSrc = user.avatar && user.avatar.trim() !== "" ? user.avatar : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=128&background=00e0ff&color=fff&bold=true`;
    document.getElementById('dashboard-profile-header').innerHTML = `
      <div class="profile-main-area">
        <img class="dash-avatar" src="${avatarSrc}" alt="avatar">
        <div class="dash-info">
          <h3>${escapeHtml(user.name)}</h3>
          <p>${user.role === 'team' ? 'Team / Club' : user.role || 'player'}</p>
          <div class="dash-stats">
            <div class="dash-stat-item" onclick="showFollowers()"><strong>${user.followers?.length || 0}</strong><span>Followers</span></div>
            <div class="dash-stat-item" onclick="showFollowing()"><strong>${user.following?.length || 0}</strong><span>Following</span></div>
            <div class="dash-stat-item"><strong>${user.posts?.length || 0}</strong><span>Posts</span></div>
          </div>
          <div class="dash-stat-actions">
            <button class="link-small" onclick="showFollowers()">View Followers</button>
            <button class="link-small" onclick="showFollowing()">View Following</button>
          </div>
        </div>
      </div>
    `;
    
    // Existing My Team card rendering
    const teamCard = document.getElementById('team-info-card');
    if (user.role === 'team'){
      // attempt to load players (if endpoint exists)
      try {
        const players = await apiRequest(`/api/users/${user._id}/players`).catch(()=>[]);
        if (players && players.length){
          teamCard.innerHTML = `<h3><i class="fas fa-shield-alt"></i> My Team</h3><ul class="item-list">${players.map(p => `<li style="padding:8px 10px;border-radius:8px;"><a href="profile.html?id=${p._id}" style="color:var(--text-light); text-decoration:none;">${escapeHtml(p.name)}</a></li>`).join('')}</ul>`;
        } else {
          teamCard.innerHTML = `<h3><i class="fas fa-shield-alt"></i> My Team</h3><p style="color:var(--text-secondary);">No players yet.</p>`;
        }
      } catch(e){
        teamCard.innerHTML = `<h3><i class="fas fa-shield-alt"></i> My Team</h3><p style="color:var(--text-secondary);">Could not load players.</p>`;
      }
    } else {
      if (user.team){
        teamCard.innerHTML = `<h3><i class="fas fa-shield-alt"></i> My Team</h3><ul class="item-list"><li style="padding:8px 10px;border-radius:8px;"><a href="profile.html?id=${user.team._id}" style="color:var(--text-light); text-decoration:none;">${escapeHtml(user.team.name)}</a></li></ul>`;
      } else {
        teamCard.innerHTML = `<h3><i class="fas fa-shield-alt"></i> My Team</h3><div style="margin-top:10px;"><button class="btn" onclick="findTeam()">Find a Team</button></div>`;
      }
    }
    
    // 2. Player Join Request Management (if Team)
    const joinRequestsCard = document.getElementById('join-requests-card');
    if (user.role === 'team') {
      joinRequestsCard.style.display = 'block';
      renderJoinRequests(user.joinRequests);
    } else {
      joinRequestsCard.style.display = 'none';
    }

  } catch (err){
    console.error('Failed to load profile', err);
    document.getElementById('dashboard-profile-header').innerHTML = `<p style="color:tomato">Could not load profile.</p>`;
  }
}

// Renders pending join requests for a team manager
function renderJoinRequests(requests) {
    const list = document.getElementById('join-requests-list');
    const pendingRequests = (requests || []).filter(r => r.status === 'pending');
    
    if (pendingRequests.length === 0) {
        list.innerHTML = `<p style="color:var(--text-secondary); margin:0; padding:10px 0;">No pending join requests.</p>`;
        return;
    }

    list.innerHTML = pendingRequests.map(req => {
        // Player is populated in the user object
        const playerName = escapeHtml(req.player.name); 
        const playerId = req.player._id;
        
        return `
            <li style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.08);">
                <a href="profile.html?id=${playerId}" style="color:var(--text-light); font-weight:600; text-decoration:none;">${playerName}</a>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-sm" style="background:var(--secondary-color); color:#000; padding:4px 8px;" 
                            onclick="handleJoinRequest('${req._id}', 'approved')">Approve</button>
                    <button class="btn btn-sm" style="background:none; border:1px solid tomato; color:tomato; padding:4px 8px;" 
                            onclick="handleJoinRequest('${req._id}', 'rejected')">Reject</button>
                </div>
            </li>
        `;
    }).join('');
}

// Handles the approval/rejection of a player's request
async function handleJoinRequest(requestId, status) {
    try {
        const btn = event.currentTarget;
        btn.disabled = true;
        
        await apiRequest(`/api/users/manage-join-request/${requestId}`, 'PUT', { status }); // Calls backend
        alert(`Request ${status} successfully.`);
        
        // Reload the profile to update the dashboard immediately
        await loadProfile(); 
    } catch (error) {
        alert(`Failed to manage request: ${error.message}`);
        // If an error occurs, the button is re-enabled to allow retry
        const allBtns = document.querySelectorAll(`[onclick*="handleJoinRequest('${requestId}'"]`);
        allBtns.forEach(b => b.disabled = false);
    }
}


/* Followers / Following modal */
function getActionBtn(user) {
    if (user._id === userId) return ''; // Cannot follow yourself

    const isFollowing = currentFollowingIds.includes(user._id);

    if (isFollowing) {
        return `<button class="btn btn-sm" style="background:tomato; padding:4px 10px;" 
                        onclick="unfollowUser('${user._id}', this)">Unfollow</button>`;
    } else {
        return `<button class="btn btn-sm" style="background:var(--primary-blue); padding:4px 10px;" 
                        onclick="followUser('${user._id}', this)">Follow</button>`;
    }
}

// Renders modal with enhanced UI and action buttons
function openFollowModal(title, users){
  document.getElementById('followModalTitle').textContent = title;
  const list = document.getElementById('followList');
  
  // Clear the list first
  list.innerHTML = ''; 
  
  if (!users || users.length === 0) {
    list.innerHTML = `<p style="color:var(--text-secondary); text-align: center; padding: 20px 0;">No users found.</p>`;
  } else {
    // Check if the users array contains populated user objects or just IDs
    const isPopulated = users.length > 0 && typeof users[0] === 'object' && users[0] !== null && users[0].name;

    if (!isPopulated) {
        list.innerHTML = `<p style="color:tomato; text-align: center; padding: 20px 0;">Error: User data is incomplete. Try reloading the page.</p>`;
        // In a real app, you would fetch the user data for each ID here.
        return; 
    }

    list.innerHTML = users.map(u => {
        // Fallback for avatar and name
        const userName = escapeHtml(u.name || 'Unknown User');
        const userAvatar = u.avatar ? encodeURI(u.avatar) : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userName) + '&size=64&background=00e0ff&color=fff';
        
        // This generates the visually enhanced list item
        return `
          <div class="fuser">
            <div class="fuser-info">
              <img src="${userAvatar}" alt="avatar">
              <a class="fuser-name" href="profile.html?id=${u._id}">${userName}</a>
            </div>
            ${getActionBtn(u)}
          </div>
        `;
    }).join('');
  }
  openModal('followModal');
}

async function showFollowers(){
  try{
    // The /api/users/me endpoint populates 'followers' with user objects
    const me = await apiRequest('/api/users/me'); 
    openFollowModal('Followers', me.followers || []);
  } catch(e) { 
    alert('Could not load followers/following lists: ' + e.message); 
    console.error(e); 
  }
}
async function showFollowing(){
  try{
    // The /api/users/me endpoint populates 'following' with user objects
    const me = await apiRequest('/api/users/me'); 
    openFollowModal('Following', me.following || []);
  } catch(e) { 
    alert('Could not load followers/following lists: ' + e.message); 
    console.error(e); 
  }
}
function closeFollowModal(){ closeModal('followModal'); }

/* follow user */
async function followUser(uid, btn){
  try{
    btn.disabled = true;
    await apiRequest(`/api/users/${uid}/follow`, 'POST'); // Calls backend
    
    // Update state and UI
    if (!currentFollowingIds.includes(uid)) currentFollowingIds.push(uid);
    btn.textContent = 'Unfollow';
    btn.style.background = 'tomato';
    btn.onclick = () => unfollowUser(uid, btn);
    await loadProfile(); // Reload dashboard profile stats
    
  } catch (e) {
    btn.disabled = false;
    alert('Could not follow user: ' + e.message);
  }
}

// FINAL CORRECTED FUNCTION: Handles unfollowing a user
async function unfollowUser(uid, btn){
    try {
        btn.disabled = true;
        // This is the call that requires the backend DELETE /api/users/:id/follow route
        await apiRequest(`/api/users/${uid}/follow`, 'DELETE'); 
        
        // Update state and UI
        currentFollowingIds = currentFollowingIds.filter(id => id !== uid);
        btn.textContent = 'Follow';
        btn.style.background = 'var(--primary-blue)';
        btn.onclick = () => followUser(uid, btn);
        
        // Keep the modal open but update the dashboard stats
        await loadProfile(); 
        
    } catch (e) {
        btn.disabled = false;
        alert('Could not unfollow user: ' + e.message);
    }
}


/* Feed */
async function loadFeed(){
  try{
    const posts = await apiRequest('/api/posts/feed'); 
    const feed = document.getElementById('feed');
    if (!posts || posts.length === 0) {
      feed.innerHTML = `<p style="color:var(--text-secondary)">Your feed is empty.</p>`;
      return;
    }
    feed.innerHTML = posts.map(p => `
      <div class="post">
        <div class="post-header">${escapeHtml(p.user?.name || 'User')}</div>
        <div class="post-body"><p style="margin:0;color:var(--text-light)">${escapeHtml(p.caption || '')}</p></div>
      </div>
    `).join('');
  } catch (e) {
    console.error('Failed to load feed', e);
    document.getElementById('feed').innerHTML = `<p style="color:tomato">Could not load feed.</p>`;
  }
}

/* Post modal */
function openPostModal(){ openModal('postModal'); }
function closePostModal(){ closeModal('postModal'); }
async function createPostFromModal(){
  const captionEl = document.getElementById('modal-post-caption');
  const caption = (captionEl.value || '').trim();
  if (!caption) return alert('Post cannot be empty.');
  try {
    await apiRequest('/api/posts', 'POST', { caption }); 
    captionEl.value = '';
    closePostModal();
    await loadFeed();
    await loadProfile();
  } catch (e) { alert('Failed to create post.'); console.error(e); }
}

/* Tournaments */
async function loadTournaments(){
  try{
    const tournaments = await apiRequest('/api/tournaments'); 
    const el = document.getElementById('tournaments-list');
    if (!tournaments || tournaments.length === 0) {
      el.innerHTML = `<p style="color:var(--text-secondary)">No tournaments available.</p>`; return;
    }
    el.innerHTML = tournaments.map(t => `
      <li>
        <a href="tournament-details.html?id=${t._id}">${escapeHtml(t.name)}</a>
        ${t.status ? `<span class="tourn-pill" style="background:${t.status === 'live' ? 'rgba(94,252,130,0.08)' : 'rgba(0,224,255,0.03)'}; border-color: rgba(0,224,255,0.06); color:${t.status === 'live' ? 'var(--secondary-color)' : 'var(--text-secondary)'}">${escapeHtml(capitalize(t.status))}</span>` : ''}
      </li>
    `).join('');
  } catch (e) {
    console.error('Failed to load tournaments', e);
    document.getElementById('tournaments-list').innerHTML = `<p style="color:tomato">Could not load tournaments.</p>`;
  }
}

/* Recommendations */
async function loadRecommendations(){
  try{
    const recs = await apiRequest('/api/users/recommendations'); 
    const el = document.getElementById('recommended-list');
    if (!recs || recs.length === 0) { el.innerHTML = `<p style="color:var(--text-secondary)">No recommendations right now.</p>`; return; }
    el.innerHTML = recs.map(u => `
      <li>
        <div class="reco-left">
          <img src="${u.avatar ? encodeURI(u.avatar) : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name) + '&size=64&background=00e0ff&color=fff'}" alt="avatar">
          <a class="reco-name" href="profile.html?id=${u._id}">${escapeHtml(u.name)}</a>
        </div>
        <div><button class="btn btn-sm" onclick="followUser('${u._id}', this)">Follow</button></div>
      </li>
    `).join('');
  } catch (e) {
    console.error('Failed to load recommendations', e);
    document.getElementById('recommended-list').innerHTML = `<p style="color:tomato">Could not load recommendations.</p>`;
  }
}

/* Helpers: modal open/close + small utils */
function openModal(id){ const el = document.getElementById(id); if (el) el.style.display = 'flex'; }
function closeModal(id){ const el = document.getElementById(id); if (el) el.style.display = 'none'; }
function findTeam(){ window.location.href = 'find-team.html'; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function capitalize(s){ if(!s) return ''; return s.charAt(0).toUpperCase()+s.slice(1); }


/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  loadProfile();
  loadFeed();
  loadTournaments();
  loadRecommendations();
});
function openCreateTournament(){
  window.location.href = "create-tournament.html";
}

</script>
</body>
</html>