<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - SportsConnect</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
  --primary-blue: #00b4d8;
  --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  --card-glass: rgba(255, 255, 255, 0.08);
  --border-light: rgba(255, 255, 255, 0.2);
  --text-light: #f8f9fa;
}
body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-gradient);
  color: var(--text-light);
  display: flex; justify-content: center; align-items: flex-start;
  min-height: 100vh;
}
.container {
  width: 100%; max-width: 900px;
  margin: 50px auto; padding: 20px;
  position: relative;
}
.card {
  background: var(--card-glass);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-light);
  border-radius: 25px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  padding-bottom: 20px;
}
.profile-header-banner { height:180px; background:linear-gradient(135deg,#0077b6,#00b4d8); }
.profile-content { display:flex; flex-direction:column; align-items:center; margin-top:-80px; padding:0 20px; }
.profile-avatar { width:150px; height:150px; border-radius:50%; border:5px solid var(--primary-blue); background-color:#fff; object-fit:cover; }
.profile-info { text-align:center; margin-top:15px; }
.profile-info h1 { margin:10px 0 5px; font-size:2em; }
.profile-info p { margin:3px 0; color:rgba(255,255,255,0.8); }

.stats-inline {
  display: flex; justify-content: center; gap: 40px; margin-top: 15px;
}
.stats-inline .stat { text-align: center; }
.stats-inline .stat strong { font-size: 1.2em; display: block; color: #fff; }
.stats-inline .stat span { color: rgba(255,255,255,0.8); font-size: 0.9em; }

.btn-group { display:flex; gap:15px; justify-content:center; margin-top:15px; }
.btn {
  padding:10px 20px; background:var(--primary-blue);
  border:none; border-radius:8px; color:#fff;
  cursor:pointer; font-weight:bold; transition:0.3s;
}
.btn:hover { background:#0096c7; }

.tabs { display:flex; justify-content:center; gap:20px; margin-top:25px; }
.tab-btn {
  background:none; border:none; color:rgba(255,255,255,0.6);
  font-size:1em; cursor:pointer; padding:10px 20px;
  border-bottom:2px solid transparent; transition:0.3s;
}
.tab-btn.active { color:var(--primary-blue); border-bottom:2px solid var(--primary-blue); }

.tab-content { padding:20px 25px; }
.tab-pane { display:none; }
.tab-pane.active { display:block; }

.posts-scroll-box {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:15px; max-height:350px; overflow-y:auto;
}
.post-card {
  background:rgba(255,255,255,0.1);
  border-radius:12px; padding:15px;
  border:1px solid rgba(255,255,255,0.1);
}
.stat-card {
  background:rgba(255,255,255,0.1);
  border-radius:12px;
  padding:15px;
  border:1px solid rgba(255,255,255,0.1);
  margin-bottom:12px;
}
.stat-card h3 {
  color: var(--primary-blue);
  margin-bottom: 8px;
}

/* back arrow */
.back-link {
  position:absolute; top:20px; left:20px;
  width:45px; height:45px; border-radius:50%;
  background:rgba(0,0,0,0.5); color:#fff;
  display:flex; justify-content:center; align-items:center;
  text-decoration:none; font-size:18px;
  z-index: 10;
}
.back-link:hover { background:rgba(0,0,0,0.7); }

@media(max-width:600px) {
  .profile-avatar { width:120px; height:120px; }
  .profile-info h1 { font-size:1.5em; }
  .stats-inline { gap:25px; }
}
</style>
</head>
<body>
<div class="container">
  <a href="dashboard.html" class="back-link"><i class="fas fa-arrow-left"></i></a>
  <div class="card" id="profile-container">
    <p style="padding:40px;text-align:center;color:rgba(255,255,255,0.7);">Loading profile...</p>
  </div>
</div>

<script>
const token = localStorage.getItem("token");
const currentUserId = localStorage.getItem("userId");
if (!token) window.location.href = "index.html";

const urlParams = new URLSearchParams(window.location.search);
const profileId = urlParams.get('id') || currentUserId;

async function apiRequest(endpoint, method='GET', body=null) {
  const opts = { method, headers: { 'Authorization': 'Bearer ' + token } };
  if (body) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const res = await fetch(`http://localhost:5000${endpoint}`, opts);
  if (!res.ok) throw new Error('API request failed');
  return res.status === 204 ? null : res.json();
}

function renderProfile(user) {
  const container = document.getElementById('profile-container');
  const isOwn = user._id === currentUserId;
  const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=160&background=00b4d8&color=fff&bold=true`;

  let overallStatsHTML = "";
if (user.overallStats && typeof user.overallStats === "object") {
  overallStatsHTML = Object.entries(user.overallStats)
    .map(([key,val]) => `<div class="stat"><strong>${val}</strong><span>${key}</span></div>`).join('');
} else {
  overallStatsHTML = `<p style="text-align:center;color:rgba(255,255,255,0.7);">No overall stats yet.</p>`;
}


  const actions = isOwn
    ? `<div class="btn-group">
         <a href="edit-profile.html" class="btn">Edit Profile</a>
         <a href="match-stat.html" class="btn">Add Stats</a>
       </div>`
    : `<div class="btn-group"><button class="btn" onclick="followUser('${user._id}')">Follow</button></div>`;

  container.innerHTML = `
    <div class="profile-header-banner"></div>
    <div class="profile-content">
      <img src="${avatar}" class="profile-avatar" alt="Avatar">
      <div class="profile-info">
        <h1>${user.name} (${user.role?.toUpperCase() || ''})</h1>
        <p>${user.bio || 'No bio yet.'}</p>
        ${user.sport ? `<p>Sport: ${user.sport}</p>` : ''}
      </div>
      <div class="stats-inline">
        <div class="stat"><strong>${user.posts?.length||0}</strong><span>Posts</span></div>
        <div class="stat"><strong>${user.followers?.length||0}</strong><span>Followers</span></div>
        <div class="stat"><strong>${user.following?.length||0}</strong><span>Following</span></div>
      </div>
      ${actions}
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab(event,'posts')">Posts</button>
        <button class="tab-btn" onclick="showTab(event,'matchstats')">Stats</button>
        <button class="tab-btn" onclick="showTab(event,'overallstats')">Overall Stats</button>
      </div>

      <div class="tab-content">
        <div id="posts-content" class="tab-pane active">${renderPosts(user.posts)}</div>
        <div id="matchstats-content" class="tab-pane"><p style="text-align:center;color:rgba(255,255,255,0.7);">Loading stats...</p></div>
        <div id="overallstats-content" class="tab-pane"><div class="stats-row">${overallStatsHTML}</div></div>
      </div>
    </div>`;
  
  // Load match stats separately
  loadMatchStats(user._id);
}

function renderPosts(posts) {
  if (!posts?.length) return `<p style="text-align:center;color:rgba(255,255,255,0.7);">No posts yet.</p>`;
  return `<div class="posts-scroll-box">
    ${posts.map(p=>`<div class="post-card"><p>${p.caption}</p></div>`).join('')}
  </div>`;
}

// ✅ New Function — Load Match Stats from backend
async function loadMatchStats(userId) {
  try {
    // Get the user data
    const endpoint = userId === currentUserId ? '/api/users/me' : `/api/users/${userId}`;
    const user = await apiRequest(endpoint);

    const data = user.matchStats || []; // get all match stats
    const statsContainer = document.getElementById('matchstats-content');

    if (!data.length) {
      statsContainer.innerHTML = `<p style="text-align:center;color:rgba(255,255,255,0.7);">No match stats available yet.</p>`;
      return;
    }

    // Display each match stat in a card
    statsContainer.innerHTML = data.map(s => `
      <div class="stat-card">
        <h3>${s.sport || 'Game'}</h3>
        <p><b>Date:</b> ${s.matchDate || 'N/A'}</p>
        <p><b>Opponent:</b> ${s.opponent || 'N/A'}</p>
        <div>${Object.entries(s.stats || {}).map(([k,v]) => `<div>${k}: ${v}</div>`).join('')}</div>
      </div>
    `).join('');
  } catch (err) {
    document.getElementById('matchstats-content').innerHTML =
      `<p style="text-align:center;color:#ff6b6b;">Could not load stats: ${err.message}</p>`;
  }
}


function showTab(e, name) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-content').classList.add('active');
  e.currentTarget.classList.add('active');
}

async function followUser(id) {
  try {
    await apiRequest(`/api/users/${id}/follow`, 'POST');
    alert('Followed!');
    loadProfile();
  } catch (err) { alert('Error following user'); }
}

async function loadProfile() {
  try {
    const endpoint = profileId === currentUserId ? '/api/users/me' : `/api/users/${profileId}`;
    const user = await apiRequest(endpoint);
    renderProfile(user);
  } catch (err) {
    document.getElementById('profile-container').innerHTML =
      `<p style="padding:20px;color:#ff6b6b;text-align:center;">Could not load profile: ${err.message}</p>`;
  }
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>
