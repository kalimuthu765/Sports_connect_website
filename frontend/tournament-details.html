<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tournament Details - SportsConnect</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tournament-details.css">
</head>
<body>

<nav class="navbar">
    <a href="dashboard.html" class="navbar-brand">SportsConnect</a>
    <div class="navbar-links">
        <a href="profile.html">Profile</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container tournament-details-container">
    <a href="dashboard.html" class="back-link">&larr; Go Back</a>
    
    <div class="header">
        <h1 id="tournament-name">Loading...</h1>
        <p><strong>Organizer:</strong> <span id="tournament-organizer"></span></p>
    </div>
    
    <div id="registration-status" class="card registration-card"></div>

    <div id="organizer-panel" class="card organizer-card" style="display: none;">
        <h2>Organizer Panel</h2>
        <a id="schedule-match-btn" class="btn" href="#">Schedule Match</a>
        <h3>Pending Registrations</h3>
        <ul id="pending-teams" class="team-list"></ul>
    </div>
    
    <div class="card teams-card">
        <h2>Approved Teams</h2>
        <ul id="approved-teams" class="team-list"></ul>
    </div>
    
    <div class="card matches-card">
        <h2>Scheduled Matches</h2>
        <div id="matches-list-container">
            <p>No matches scheduled yet.</p>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    function logout() {
        localStorage.clear();
        window.location.href = "index.html";
    }

    // ✅ FIXED apiRequest: Logs detailed error from server
    async function apiRequest(url, options = {}) {
        const res = await fetch(`http://localhost:5000${url}`, {
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, ...options
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({ message: `HTTP Error ${res.status}` }));
            console.error("API Request Failed:", url, err); // Log the failure details
            throw new Error(err.message || 'API request failed');
        }
        return res.json();
    }

    async function loadPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const tournamentId = urlParams.get('id');

        if (!tournamentId || tournamentId === 'null') {
            alert('Error: Tournament ID is missing from the URL.');
            window.location.href = 'dashboard.html';
            return;
        }

        try {
            const [tournamentData, currentUser] = await Promise.all([
                apiRequest(`/api/tournaments/${tournamentId}`),
                apiRequest('/api/users/me')
            ]);
            
            // ✅ FIX: Use optional chaining for robustness
            document.getElementById('tournament-name').textContent = tournamentData.name || 'Tournament Details';
            
            const organizerName = tournamentData.organizer?.name || 'N/A';
            document.getElementById('tournament-organizer').textContent = organizerName;

            renderTeamLists(tournamentData.teams);
            renderMatches(tournamentData.matches, currentUser, tournamentData);
            
            if (currentUser && tournamentData.organizer) {
                if (currentUser._id === tournamentData.organizer._id) {
                    document.getElementById('organizer-panel').style.display = 'block';
                    document.getElementById('schedule-match-btn').href = `schedule-match.html?id=${tournamentId}`;
                } else if (currentUser.role === 'team') {
                    renderRegistrationButton(tournamentData.teams, currentUser);
                }
            }
            
            // Socket.IO connection
            const socket = io();
            socket.on("connect", () => {
                socket.emit("join_match_room", tournamentId);
            });
            socket.on("match_update", (updatedMatch) => {
                const updatedMatches = tournamentData.matches.map(m => m._id === updatedMatch._id ? updatedMatch : m);
                tournamentData.matches = updatedMatches;
                renderMatches(tournamentData.matches, currentUser, tournamentData);
            });


        } catch (error) {
            // Display the specific error message from the API or the default failure message
            alert(`Error loading page: ${error.message || 'Failed to fetch tournament data.'}`);
            console.error(`Page Load Failure:`, error);
        }
    }

    // ✅ FIXED: renderTeamLists (Added null checks for team/team.name)
    function renderTeamLists(teams) {
        const approvedList = document.getElementById('approved-teams');
        const pendingList = document.getElementById('pending-teams');

        // Filter for teams where the 'team' object is successfully populated
        const approvedTeams = teams.filter(t => t.status === 'approved' && t.team && t.team.name);
        const pendingTeams = teams.filter(t => t.status === 'pending' && t.team && t.team.name);

        approvedList.innerHTML = approvedTeams.length > 0 
            ? approvedTeams.map(t => `<li>${t.team.name}</li>`).join('') 
            : "<li><p>No teams approved yet.</p></li>";
        
        if (pendingList) {
            pendingList.innerHTML = pendingTeams.length > 0 
                ? pendingTeams.map(reg => `
                <li class="pending-item">
                    <span>${reg.team.name}</span>
                    <div class="actions">
                        <button class="btn approve-btn" onclick="handleRegistration('${reg.team._id}', 'approved')">Approve</button>
                        <button class="btn reject-btn" onclick="handleRegistration('${reg.team._id}', 'rejected')">Reject</button>
                    </div>
                </li>
            `).join('') : "<li><p>No pending requests.</p></li>";
        }
    }

    function renderRegistrationButton(teams, currentUser) {
        const registrationDiv = document.getElementById('registration-status');
        // Find registration using the populated team._id
        const myRegistration = teams.find(t => t.team?._id === currentUser._id);

        if (myRegistration) {
            let statusText = '';
            let statusClass = '';
            if (myRegistration.status === 'pending') {
                statusText = 'Your request is in the waiting list.';
                statusClass = 'status-pending';
            } else if (myRegistration.status === 'approved') {
                statusText = 'You have been approved to join this tournament!';
                statusClass = 'status-approved';
            } else if (myRegistration.status === 'rejected') {
                statusText = 'Your request was rejected.';
                statusClass = 'status-rejected';
            }
            registrationDiv.innerHTML = `<p class="status-message ${statusClass}">${statusText}</p>`;
        } else {
            registrationDiv.innerHTML = `<button class="btn register-btn" onclick="registerForTournament()">Register Your Team</button>`;
        }
    }
    
    // ✅ FIXED: renderMatches (Added null checks for team/team.name)
    function renderMatches(matches, currentUser, tournamentData) {
        const matchesContainer = document.getElementById('matches-list-container');
        if (!matches || matches.length === 0) {
            matchesContainer.innerHTML = '<p>No matches scheduled yet.</p>';
            return;
        }
        
        const isOrganizer = currentUser && tournamentData.organizer && currentUser._id === tournamentData.organizer._id;

        const matchesHTML = matches.map(match => {
            // Use optional chaining for match.teams elements
            const validTeams = match.teams.filter(t => t && t.name);
            const teamNames = validTeams.map(t => t.name).join(' vs ');

            return `
            <div class="match-item">
                <div class="match-details">
                    <p><strong>Match:</strong> ${match.matchName}</p>
                    <p><strong>Date:</strong> ${new Date(match.date).toLocaleDateString()}</p>
                    <p><strong>Location:</strong> ${match.location}</p>
                    <p><strong>Teams:</strong> ${teamNames || 'TBD'}</p>
                    <p><strong>Status:</strong> ${match.status}</p>
                    ${match.scorecard ? renderFullScorecard(match.scorecard, tournamentData.sport) : ''}
                </div>
                ${isOrganizer ? 
                    `<button class="btn update-score-btn" onclick="openUpdateScorecardPage('${match._id}', '${tournamentData.sport}', '${teamNames}')">Update Score</button>` 
                    : ''
                }
            </div>
            `;
        }).join('');

        matchesContainer.innerHTML = matchesHTML;
    }
    
    function renderFullScorecard(scorecard, sport) {
        if (!scorecard || Object.keys(scorecard).length === 0) return '';
        
        let scorecardHtml = '<div class="match-scorecard">';
        
        const team1 = scorecard.team1;
        const team2 = scorecard.team2;
        
        const team1Name = team1.team?.name || team1.name || 'Team 1';
        const team2Name = team2.team?.name || team2.name || 'Team 2';

        if (sport === 'Cricket') {
            scorecardHtml += `
                <div class="scorecard-section">
                    <h4>${team1Name}</h4>
                    <p>Score: ${team1.score} in ${team1.overs} overs</p>
                </div>
                <div class="scorecard-section">
                    <h4>${team2Name}</h4>
                    <p>Score: ${team2.score} in ${team2.overs} overs</p>
                </div>
            `;
        } else if (sport === 'Football') {
             scorecardHtml += `
                <div class="scorecard-section">
                    <h4>${team1Name}</h4>
                    <p>Goals: ${team1.score}</p>
                </div>
                <div class="scorecard-section">
                    <h4>${team2Name}</h4>
                    <p>Goals: ${team2.score}</p>
                </div>
            `;
        }
        
        scorecardHtml += '</div>';
        return scorecardHtml;
    }

    function openUpdateScorecardPage(matchId, sport, teamNames) {
        const tournamentId = new URLSearchParams(window.location.search).get('id');
        const url = `update-scorecard.html?tournamentId=${tournamentId}&matchId=${matchId}&sport=${sport}&teams=${teamNames}`;
        window.open(url, '_blank', 'width=600,height=800,resizable=yes');
    }

    async function registerForTournament() {
        const urlParams = new URLSearchParams(window.location.search);
        const tournamentId = urlParams.get('id');

        try {
            const result = await apiRequest(`/api/tournaments/${tournamentId}/register`, { method: 'POST' }); // Calls backend
            alert(result.message);
            loadPage();
        } catch(error) { alert(`Error: ${error.message}`); }
    }

    async function handleRegistration(teamId, status) {
        const urlParams = new URLSearchParams(window.location.search);
        const tournamentId = urlParams.get('id');

        try {
            await apiRequest(`/api/tournaments/${tournamentId}/registrations/${teamId}`, { method: 'PUT', body: JSON.stringify({ status }) }); // Calls backend
            alert(`Request ${status} successfully.`);
            loadPage();
        } catch(error) { alert(`Error: ${error.message}`); }
    }

    document.addEventListener('DOMContentLoaded', loadPage);
</script>
</body>
</html>