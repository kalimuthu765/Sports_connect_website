<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - Compact Full Screen SportsConnect</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* --- ðŸŒŸ Final Compact & Attractive Layout CSS --- */
:root {
  --primary-blue: #00b4d8;
  --vibrant-orange: #ff7b00; 
  --bg-gradient: linear-gradient(135deg, #101216, #1a1d22, #21252b); 
  --text-light: #f8f9fa;
  --highlight-yellow: #ffc300; 
}
body {
  margin: 0; 
  padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-gradient);
  color: var(--text-light);
  min-height: 100vh;
}
.container {
  width: 100%; 
  max-width: 1300px;
  margin: 0 auto; 
  padding: 0 40px;
  position: relative;
}

/* Header structure for the top-level 3-column alignment */
.profile-header-meta {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr; /* Left (Small), Center (Wide), Right (Small) */
    padding-top: 30px; 
    align-items: flex-start;
    min-height: 150px; 
}

/* --- LEFT: Horizontal Posts/Follows/Following (COMPACT) --- */
.meta-left {
    display: flex; 
    flex-direction: row; 
    gap: 15px; 
    text-align: center;
    padding-top: 20px;
}
.stat-item {
    font-size: 0.9em; 
    font-weight: bold;
    line-height: 1.2;
    padding: 0 5px;
}
.stat-item strong { 
    display: block;
    font-size: 1.2em; 
    color: var(--highlight-yellow); 
}
.stat-item span { 
    color: rgba(255,255,255,0.7); 
    font-size: 0.7em; 
    font-weight: normal; 
    text-transform: uppercase;
}

/* --- CENTER: Name/Sport/Bio --- */
.meta-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.profile-info { margin-top: 0; }
.profile-info h1 { 
    margin:0 0 5px; 
    font-size:2.5em; 
}
.profile-info p.bio { margin:0 0 5px; color:rgba(255,255,255,0.8); font-style: italic;}
.profile-info p.sport { margin:0 0 20px; color:var(--primary-blue); font-weight: bold; font-size: 1.1em;}


/* --- RIGHT: Small Avatar & Action --- */
.meta-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* Right align avatar and action */
    text-align: right;
}
.profile-avatar-container {
    margin-bottom: 5px; 
}
.profile-avatar { 
    width:60px; height:60px; /* VERY SMALL SIZE */
    border-radius:50%; 
    border:3px solid var(--vibrant-orange); /* Thin border */
    background-color:#fff; 
    object-fit:cover; 
}
.edit-profile-action {
    color: var(--primary-blue);
    font-size: 0.8em; /* Smaller action text */
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.3s;
}
.edit-profile-action:hover { color: var(--highlight-yellow); }


/* --- CENTERED TABS and Content Area --- */
.content-area {
    width: 100%;
    margin-top: 30px; 
    display: flex;
    flex-direction: column;
    align-items: center;
}
/* ADD STATS button styling */
.add-stats-btn {
    padding:15px 40px; 
    background:var(--vibrant-orange); /* Changed to orange for high prominence */
    border:none; border-radius:10px; color:#fff;
    cursor:pointer; font-weight:bold; transition:0.3s;
    text-decoration: none;
    margin-bottom: 25px; /* Space below button, above tabs */
    box-shadow: 0 4px 15px rgba(255, 123, 0, 0.5);
}
.add-stats-btn:hover { background: #ff9a3c; }


.tabs-container {
    display:flex; justify-content:center; gap:80px; 
    padding: 15px 0;
    margin-bottom: 20px;
    border-bottom: 3px solid rgba(255,255,255,0.1); 
    width: 80%; 
}
.tab-btn {
  background:none; border:none; color:rgba(255,255,255,0.7);
  font-size:1.2em; 
  cursor:pointer; padding:10px 15px;
  border-bottom:4px solid transparent; transition:0.3s;
  font-weight: 700;
  text-transform: uppercase;
}
.tab-btn.active { color:var(--primary-blue); border-bottom:4px solid var(--primary-blue); } /* Blue for active tab */

.tab-content { padding:20px 25px; width: 100%; max-width: 1000px;}
.tab-pane { display:none; }
.tab-pane.active { display:block; }

.posts-scroll-box, .stats-row {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:25px; 
    padding: 10px;
}
.stat-card {
    background:rgba(255,255,255,0.05); 
    border-radius:10px;
    padding:20px;
    border:1px solid rgba(255,255,255,0.1);
}

/* Media Query for smaller screens (remains the same) */
@media(max-width:900px) {
    .profile-header-meta {
        grid-template-columns: 1fr; 
        padding-left: 20px;
        padding-right: 20px;
        text-align: center;
    }
    .meta-left {
        justify-content: center;
        order: 2;
        margin-top: 20px;
    }
    .meta-center { order: 1; margin-bottom: 10px; }
    .meta-right { 
        align-items: center;
        text-align: center;
        order: 3;
    }
    .content-area { margin-top: 30px; }
    .tabs-container { width: 100%; gap: 10px; }
}
</style>
</head>
<body>
<div class="container">
  
    <div id="profile-container">
      <p style="padding:40px;text-align:center;color:rgba(255,255,255,0.7);">Loading profile...</p>
    </div>
</div>

<script>
const token = localStorage.getItem("token");
const currentUserId = localStorage.getItem("userId");
if (!token) window.location.href = "index.html";

const urlParams = new URLSearchParams(window.location.search);
const profileId = urlParams.get('id') || currentUserId;

async function apiRequest(endpoint, method='GET', body=null) {
  const opts = { method, headers: { 'Authorization': 'Bearer ' + token } };
  if (body) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const res = await fetch(`http://localhost:5000${endpoint}`, opts);
  if (!res.ok) throw new Error('API request failed');
  return res.status === 204 ? null : res.json();
}

function renderProfile(user) {
  const container = document.getElementById('profile-container');
  const isOwn = user._id === currentUserId;
  const playerRole = user.role?.toUpperCase() || 'USER';
  const roleColor = playerRole === 'PLAYER' ? 'var(--vibrant-orange)' : 'var(--primary-blue)'; 
  const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=60&background=ff7b00&color=fff&bold=true`;

  let overallStatsHTML = "";
  if (user.overallStats && typeof user.overallStats === "object") {
    overallStatsHTML = '<div class="stats-row">' + Object.entries(user.overallStats)
      .map(([key, val]) => `<div class="stat-card"><h3>${key.toUpperCase()}</h3><p style="font-size:1.8em; color: var(--highlight-yellow);">${val}</p></div>`).join('') + '</div>';
  } else {
    overallStatsHTML = `<p style="text-align:center;color:rgba(255,255,255,0.7);">No overall stats yet.</p>`;
  }

  // Right column action (Edit Profile link under small avatar)
  const rightActions = isOwn 
      ? `<a href="edit-profile.html" class="edit-profile-action"><i class="fas fa-edit"></i> Edit Profile</a>`
      : `<button class="edit-profile-action" onclick="followUser('${user._id}')" style="color:var(--vibrant-orange); border:none; background:none; cursor:pointer;">
           <i class="fas fa-user-plus"></i> Follow User
         </button>`;

  // **MOVED ACTION**: Add Stats button placed BEFORE tabs
  const addStatsButton = isOwn
      ? `<a href="match-stat.html" class="add-stats-btn"><i class="fas fa-plus-circle"></i> ADD STATS</a>`
      : '';

  container.innerHTML = `
    <div class="profile-header-meta">
        <div class="meta-left">
            <div class="stat-item"><strong>${user.posts?.length || 0}</strong><span>POSTS</span></div>
            <div class="stat-item"><strong>${user.followers?.length || 0}</strong><span>FOLLOWERS</span></div>
            <div class="stat-item"><strong>${user.following?.length || 0}</strong><span>FOLLOWING</span></div>
        </div>
        
        <div class="meta-center">
            <div class="profile-info">
                <h1>${user.name} <span style="color: ${roleColor}; font-size: 0.7em; font-weight: bold;">(${playerRole})</span></h1>
                <p class="bio">${user.bio || 'Enter a bio here.'}</p>
                ${user.sport ? `<p class="sport">SPORT: ${user.sport.toUpperCase()}</p>` : ''}
            </div>
        </div>
        
        <div class="meta-right">
            <div class="profile-avatar-container">
                <img src="${avatar}" class="profile-avatar" alt="Avatar">
            </div>
            ${rightActions}
        </div>
    </div>

    <div class="content-area">
         
        ${addStatsButton}

         <div class="tabs-container">
            <button class="tab-btn active" onclick="showTab(event,'posts')">POSTS</button>
            <button class="tab-btn" onclick="showTab(event,'matchstats')">STATS</button>
            <button class="tab-btn" onclick="showTab(event,'overallstats')">OVERALL STATS</button>
        </div>

        <div class="tab-content">
            <div id="posts-content" class="tab-pane active">${renderPosts(user.posts)}</div>
            <div id="matchstats-content" class="tab-pane"><p style="text-align:center;color:rgba(255,255,255,0.7);">Loading stats...</p></div>
            <div id="overallstats-content" class="tab-pane">${overallStatsHTML}</div>
        </div>
    </div>`;

  loadMatchStats(user._id);
}

// (The rest of the JavaScript functions remain the same)

function renderPosts(posts) {
  if (!posts?.length) return `<p style="text-align:center;color:rgba(255,255,255,0.7);">No posts yet.</p>`;
  return `<div class="posts-scroll-box">
    ${posts.map(p => `<div class="stat-card"><p>${p.caption}</p></div>`).join('')}
  </div>`;
}

async function loadMatchStats(userId) {
  try {
    const endpoint = userId === currentUserId ? '/api/users/me' : `/api/users/${userId}`;
    const user = await apiRequest(endpoint);

    const data = user.matchStats || [];
    const statsContainer = document.getElementById('matchstats-content');

    if (!data.length) {
      statsContainer.innerHTML = `<p style="text-align:center;color:rgba(255,255,255,0.7);">No match stats available yet.</p>`;
      return;
    }

    statsContainer.innerHTML = data.map(s =>
      `<div class="stat-card">
        <h3>${s.sport || 'Game'} - Match Date: ${s.matchDate || 'N/A'}</h3>
        <p><b>Opponent:</b> ${s.opponent || 'N/A'}</p>
        <div>${Object.entries(s.stats || {}).map(([k, v]) => `<div>${k}: ${v}</div>`).join('')}</div>
      </div>`
    ).join('');
  } catch (err) {
    document.getElementById('matchstats-content').innerHTML =
      `<p style="text-align:center;color:#ff6b6b;">Could not load stats: ${err.message}</p>`;
  }
}


function showTab(e, name) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-content').classList.add('active');
  e.currentTarget.classList.add('active');
}

async function followUser(id) {
  try {
    await apiRequest(`/api/users/${id}/follow`, 'POST');
    alert('Followed!');
    loadProfile();
  } catch (err) { alert('Error following user'); }
}

async function loadProfile() {
  try {
    const endpoint = profileId === currentUserId ? '/api/users/me' : `/api/users/${profileId}`;
    const user = await apiRequest(endpoint);
    renderProfile(user);
  } catch (err) {
    document.getElementById('profile-container').innerHTML =
      `<p style="padding:20px;color:#ff6b6b;text-align:center;">Could not load profile: ${err.message}</p>`;
  }
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>